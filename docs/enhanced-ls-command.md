# `uzi ls` コマンド UI/UX 仕様書

## 1. 背景と目的

現在の`uzi ls`コマンドは、アクティブなエージェントを一覧表示する基本的な機能を提供している。しかし、エージェントの数が増えるにつれて、以下の課題が顕在化している。

-   **一覧性の低下:** 多くのエージェントを同時に管理する場合、縦に長いリスト形式では全体の状況把握が困難になる。
-   **情報の不足:** 各エージェントの具体的な作業内容（どのファイルを変更しているか）や、健全性（正常に動作しているか、停止しているか）を瞬時に判断することが難しい。
-   **問題の発見の遅れ:** エージェントがエラーや無限ループに陥っていても、能動的にtmuxセッションを確認しない限り発見が遅れる可能性がある。

本仕様書は、これらの課題を解決し、複数エージェントの監視・管理をより効率的かつ直感的に行うための、新しい`uzi ls`コマンドのUI/UXを定義することを目的とする。

## 2. 設計コンセプト

**「高密度でありながら、重要な変化を見逃さないリアルタイムダッシュボード」**

一覧性を重視したテーブル形式を基本とし、各エージェントの「健全性」「作業内容」「進捗」を視覚的に表現することで、ユーザーが最小限の認知負荷でプロジェクト全体の状況を把握できるUIを目指す。

## 3. UI仕様

新しいUIは、以下のテーブルレイアウトを基本とする。リアルタイム更新 (`-w` フラグ) にも対応する。

```
 AGENT           STATUS      DIFF      FILES (+/~/-)   LAST CHANGE                             PROMPT / ERROR
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
 yuta (claude)   ✅ ready    +887/-0   [ 1/0/0 ]       docs/development/BEST_PRACTICES_JP.md   Translate dev docs...
 shiro (claude)  🏃 running  +367/-0   [ 1/0/0 ]       docs/migration/MIGRATION_JP.md          Translate migration guide...
 nana (claude)   ⚠️ stuck    +0/-0     [ 0/0/0 ]       -                                       Translate test guide...
 tomoe (claude)  ❌ error    +0/-0     [ 0/0/0 ]       -                                       Error: Infinite loop in tmux session.
 ronald (claude) 🏃 running  +618/-10  [ 3/5/2 ]       pkg/errors/errors_test.go               Refactor test suite for pkg/errors...
```

### 3.1. 表示項目定義

| 列名              | 説明                                                                                                                                                             |
| ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **AGENT**         | エージェント名と使用モデル（例: `yuta (claude)`）。                                                                                                                |
| **STATUS**        | エージェントの現在の状態を示すアイコンとテキスト。<br>詳細は「3.2. ステータス定義」を参照。                                                                         |
| **DIFF**          | Gitワークツリー内のコード差分。`+`は追加行数、`-`は削除行数を表す。                                                                                                 |
| **FILES (+/~/-)** | `[ 追加 / 変更 / 削除 ]` されたファイル数を表示する。エージェントの活動の活発さを定量的に示す。                                                                     |
| **LAST CHANGE**   | エージェントが直近で変更したファイル名。エージェントの現在の作業内容を具体的に示す。変更がない場合は `-` を表示。                                                    |
| **PROMPT / ERROR**| 通常時はエージェントに与えられたプロンプトの要約を表示。<br>`error` ステータスの場合、エラーメッセージの要約を表示し、迅速な問題特定を可能にする。                     |

### 3.2. ステータス定義

エージェントの「健康状態」を直感的に示すため、以下の4つのステータスを定義する。

| アイコン | ステータス | 説明                                                                                                 |
| -------- | ---------- | ---------------------------------------------------------------------------------------------------- |
| ✅        | **ready**  | エージェントはタスクを完了し、待機状態にある。チェックポイント（`uzi checkpoint`）が可能であることを示す。 |
| 🏃        | **running**| エージェントは現在アクティブに作業を実行中である。                                                      |
| ⚠️        | **stuck**  | エージェントは一定時間（例: 5分以上）進捗がなく、停止している可能性がある。ユーザーの注意を促す。      |
| ❌        | **error**  | エージェントのプロセスでエラーが検知された状態。ユーザーの即時介入が必要であることを示す。             |

## 4. リアルタイム更新

`uzi ls -w` または `uzi status -w` のようなコマンドで、リアルタイム更新モードを起動する。

-   **定期更新:** 1〜2秒間隔でデータを再取得し、画面全体を再描画する。
-   **変更点の強調（任意）:** 前回の描画時から変更があったセル（例: `STATUS`の変更、`DIFF`の増加）を一時的にハイライト表示することで、変更を視覚的に分かりやすくする。

## 5. 実装方針

-   **対象ファイル:** `cmd/ls/ls.go`
-   **主要関数:** `printSessions` 関数を本仕様書に沿って修正する。
-   **情報取得:**
    -   `getGitDiffTotals` 関数を拡張し、行数の差分に加えて、ファイルごとの変更ステータス（`A`, `M`, `D`）とファイル名のリストを取得する (`git diff --name-status`)。
    -   `stuck` および `error` ステータスを判定するためのロジックを `getAgentStatus` 関数に追加する。
-   **ライブラリ:** より高度なTUIを実現するために、`bubbletea` や `tview` といったGo言語のライブラリの導入を検討する。 