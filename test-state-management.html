<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ブロック崩しゲーム - 状態管理システムテスト</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1a1a1a;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background-color: #2a2a2a;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        h2 {
            color: #4CAF50;
            margin-top: 0;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            background-color: #333;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
        }
        .life-container {
            font-size: 24px;
            margin: 10px 0;
        }
        .score-display {
            font-size: 20px;
            margin: 10px 0;
        }
        .combo-display {
            font-size: 18px;
            color: #FFC107;
        }
        .log {
            background-color: #1a1a1a;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #444;
            border-radius: 4px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
        }
        .log-info { color: #4CAF50; }
        .log-warning { color: #FFC107; }
        .log-error { color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ブロック崩しゲーム - 状態管理システムテスト</h1>
        
        <!-- ゲーム状態管理 -->
        <div class="section">
            <h2>ゲーム状態管理</h2>
            <div>
                <button onclick="gameStateTest.startGame()">ゲーム開始</button>
                <button onclick="gameStateTest.pauseGame()">一時停止</button>
                <button onclick="gameStateTest.resumeGame()">再開</button>
                <button onclick="gameStateTest.stageClear()">ステージクリア</button>
                <button onclick="gameStateTest.nextStage()">次のステージ</button>
                <button onclick="gameStateTest.gameOver()">ゲームオーバー</button>
                <button onclick="gameStateTest.returnToTitle()">タイトルへ</button>
            </div>
            <div class="status" id="gameStateStatus">
                現在の状態: 読み込み中...
            </div>
        </div>
        
        <!-- スコア管理 -->
        <div class="section">
            <h2>スコアシステム</h2>
            <div>
                <button onclick="scoreTest.hitNormalBlock()">通常ブロック破壊</button>
                <button onclick="scoreTest.hitHardBlock()">硬いブロック破壊</button>
                <button onclick="scoreTest.addClearBonus()">クリアボーナス</button>
                <button onclick="scoreTest.resetCombo()">コンボリセット</button>
                <button onclick="scoreTest.resetScore()">スコアリセット</button>
            </div>
            <div class="status">
                <div class="score-display">
                    現在のスコア: <span id="currentScore">0</span>
                </div>
                <div class="score-display">
                    ハイスコア: <span id="highScore">0</span>
                </div>
                <div class="combo-display">
                    コンボ: <span id="combo">0</span> / 最大コンボ: <span id="maxCombo">0</span>
                </div>
            </div>
        </div>
        
        <!-- ライフ管理 -->
        <div class="section">
            <h2>ライフシステム</h2>
            <div>
                <button onclick="lifeTest.loseLife()">ライフを失う</button>
                <button onclick="lifeTest.gainLife()">ライフ獲得</button>
                <button onclick="lifeTest.resetLife('easy')">リセット（Easy）</button>
                <button onclick="lifeTest.resetLife('normal')">リセット（Normal）</button>
                <button onclick="lifeTest.resetLife('hard')">リセット（Hard）</button>
            </div>
            <div class="status">
                <div class="life-container" id="lifeDisplay">❤️❤️❤️</div>
                <div>残りライフ: <span id="lifeCount">3</span> / <span id="maxLifeCount">5</span></div>
                <div>ノーミス: <span id="noMiss">Yes</span></div>
            </div>
        </div>
        
        <!-- ストレージ管理 -->
        <div class="section">
            <h2>ストレージ管理</h2>
            <div>
                <button onclick="storageTest.saveAll()">全データ保存</button>
                <button onclick="storageTest.loadAll()">全データ読み込み</button>
                <button onclick="storageTest.exportData()">データエクスポート</button>
                <button onclick="storageTest.clearAll()">全データ削除</button>
                <button onclick="storageTest.showStorageInfo()">ストレージ情報</button>
            </div>
            <div class="status" id="storageStatus">
                ストレージ: 待機中...
            </div>
        </div>
        
        <!-- ログ表示 -->
        <div class="section">
            <h2>イベントログ</h2>
            <div class="log" id="eventLog"></div>
        </div>
    </div>

    <!-- JavaScriptモジュール -->
    <script type="module">
        import ScoreManager from './src/js/scoreManager.js';
        import LifeManager from './src/js/lifeManager.js';
        import GameState from './src/js/gameState.js';
        import StorageManager from './src/js/storageManager.js';
        
        // 管理クラスのインスタンス
        const scoreManager = new ScoreManager();
        const lifeManager = new LifeManager();
        const gameState = new GameState();
        const storageManager = new StorageManager();
        
        // 初期化
        scoreManager.init();
        lifeManager.init();
        gameState.init();
        
        // ログ関数
        function log(message, type = 'info') {
            const logElement = document.getElementById('eventLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // UI更新関数
        function updateUI() {
            // ゲーム状態
            const gameInfo = gameState.getGameInfo();
            document.getElementById('gameStateStatus').innerHTML = `
                現在の状態: ${gameInfo.state}<br>
                ステージ: ${gameInfo.stage} / ${gameInfo.totalStages}<br>
                プレイ時間: ${gameInfo.playTime}秒<br>
                難易度: ${gameInfo.difficulty}
            `;
            
            // スコア
            const scoreInfo = scoreManager.getScoreInfo();
            document.getElementById('currentScore').textContent = scoreInfo.currentScore;
            document.getElementById('highScore').textContent = scoreInfo.highScore;
            document.getElementById('combo').textContent = scoreInfo.combo;
            document.getElementById('maxCombo').textContent = scoreInfo.maxCombo;
            
            // ライフ
            const lifeInfo = lifeManager.getLifeInfo();
            document.getElementById('lifeDisplay').innerHTML = lifeManager.getLifeHTML();
            document.getElementById('lifeCount').textContent = lifeInfo.current;
            document.getElementById('maxLifeCount').textContent = lifeInfo.max;
            document.getElementById('noMiss').textContent = lifeInfo.isNoMiss ? 'Yes' : 'No';
        }
        
        // イベントリスナー設定
        gameState.addEventListener('stateChange', (data) => {
            log(`状態変更: ${data.previous} → ${data.current}`);
            updateUI();
        });
        
        scoreManager.addEventListener('scoreUpdate', (score) => {
            log(`スコア更新: ${score}`);
            updateUI();
        });
        
        scoreManager.addEventListener('comboUpdate', (combo) => {
            log(`コンボ更新: ${combo}`, combo > 5 ? 'warning' : 'info');
            updateUI();
        });
        
        lifeManager.addEventListener('lifeLost', (lives) => {
            log(`ライフ喪失！ 残り: ${lives}`, 'error');
            updateUI();
        });
        
        lifeManager.addEventListener('lifeGained', (data) => {
            log(`ライフ獲得！ ${data.previous} → ${data.current}`, 'warning');
            updateUI();
        });
        
        lifeManager.addEventListener('gameOver', () => {
            log('ゲームオーバー！', 'error');
            gameState.gameOver();
        });
        
        // テスト用関数をグローバルに公開
        window.gameStateTest = {
            startGame: () => gameState.startGame(),
            pauseGame: () => gameState.pauseGame(),
            resumeGame: () => gameState.resumeGame(),
            stageClear: () => gameState.stageClear(),
            nextStage: () => gameState.nextStage(),
            gameOver: () => gameState.gameOver(),
            returnToTitle: () => gameState.returnToTitle()
        };
        
        window.scoreTest = {
            hitNormalBlock: () => scoreManager.addBlockScore('normal'),
            hitHardBlock: () => scoreManager.addBlockScore('hard'),
            addClearBonus: () => {
                const bonus = scoreManager.addClearBonus(120, lifeManager.isNoMiss());
                log(`クリアボーナス獲得: ${bonus}点`, 'warning');
            },
            resetCombo: () => scoreManager.resetCombo(),
            resetScore: () => scoreManager.resetScore()
        };
        
        window.lifeTest = {
            loseLife: () => lifeManager.loseLife(),
            gainLife: () => lifeManager.gainLife(),
            resetLife: (difficulty) => lifeManager.reset(difficulty)
        };
        
        window.storageTest = {
            saveAll: () => {
                storageManager.saveHighScore(scoreManager.getHighScore());
                storageManager.saveGameSettings(gameState.getSettings());
                storageManager.saveGameProgress(gameState.generateSaveData());
                log('全データを保存しました');
            },
            loadAll: () => {
                const highScore = storageManager.loadHighScore();
                const settings = storageManager.loadGameSettings();
                const progress = storageManager.loadGameProgress();
                log(`データを読み込みました - ハイスコア: ${highScore}`);
                updateUI();
            },
            exportData: () => {
                const data = storageManager.exportData();
                console.log('エクスポートデータ:', data);
                log('データをコンソールにエクスポートしました');
            },
            clearAll: () => {
                if (confirm('本当に全データを削除しますか？')) {
                    storageManager.clearAll();
                    log('全データを削除しました', 'error');
                }
            },
            showStorageInfo: () => {
                const info = storageManager.getStorageInfo();
                document.getElementById('storageStatus').innerHTML = `
                    ストレージ利用可能: ${info.available ? 'Yes' : 'No'}<br>
                    使用容量: ${info.usedKB} KB<br>
                    保存項目数: ${info.itemCount}
                `;
            }
        };
        
        // 初期UI更新
        updateUI();
        log('システム初期化完了', 'info');
    </script>
</body>
</html>